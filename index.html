

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Receitas - Sistema Online com Firebase</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .status-vencida { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); }
        .status-vencendo { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .status-valida { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); }
        .online-indicator { animation: pulse 2s infinite; }
        .firebase-connected { animation: firebaseGlow 3s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes firebaseGlow { 0%, 100% { box-shadow: 0 0 5px #ff6b35; } 50% { box-shadow: 0 0 20px #ff6b35; } }
        .loading { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header com Status Firebase -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Controle de Receitas TricoMaster</h1>
            <div class="flex items-center justify-center gap-3 mb-4">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-orange-500 rounded-full firebase-connected" id="firebaseStatus"></div>
                    <span class="text-sm text-gray-600" id="connectionStatus">Conectando ao Firebase...</span>
                </div>
                <div class="text-sm text-gray-500" id="usuariosOnline">Carregando usuários...</div>
            </div>
            <div class="bg-orange-100 border border-orange-300 rounded-lg p-3 text-sm text-orange-800">
                <strong>🔥 Firebase Ativo:</strong> Dados sincronizados em tempo real entre toda a equipe
            </div>
            
            <!-- Firebase Setup Instructions -->
            <div id="firebaseInstructions" class="bg-yellow-50 border border-yellow-300 rounded-lg p-4 text-sm text-yellow-800 mt-4" style="display: none;">
                <h3 class="font-bold mb-2">⚠️ Configuração Necessária do Firebase</h3>
                <p class="mb-2">Se aparecer erro de permissão, siga estes passos:</p>
                <ol class="text-left list-decimal list-inside space-y-1 max-w-2xl mx-auto">
                    <li>Acesse <a href="https://console.firebase.google.com" target="_blank" class="underline">console.firebase.google.com</a></li>
                    <li>Clique no seu projeto: <strong>controle-de-receitas-14d86</strong></li>
                    <li>Menu lateral: <strong>Firestore Database</strong></li>
                    <li>Aba <strong>"Rules"</strong> (Regras)</li>
                    <li>Cole o código abaixo e clique <strong>"Publicar"</strong></li>
                </ol>
                <div class="bg-gray-100 p-3 rounded mt-3 text-xs font-mono text-left">
                    rules_version = '2';<br>
                    service cloud.firestore {<br>
                    &nbsp;&nbsp;match /databases/{database}/documents {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;match /{document=**} {<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;allow read, write: if true;<br>
                    &nbsp;&nbsp;&nbsp;&nbsp;}<br>
                    &nbsp;&nbsp;}<br>
                    }
                </div>
                <button onclick="document.getElementById('firebaseInstructions').style.display='none'" 
                        class="mt-3 bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded text-sm">
                    Entendi, já configurei
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Vencendo (7 dias)</p>
                        <p class="text-3xl font-bold text-yellow-600" id="vencendo">-</p>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-full">
                        <span class="text-2xl">⚠️</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Vencidas</p>
                        <p class="text-3xl font-bold text-red-600" id="vencidas">-</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <span class="text-2xl">🚨</span>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total de Receitas</p>
                        <p class="text-3xl font-bold text-blue-600" id="totalReceitas">-</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <span class="text-2xl">📋</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Firebase -->
        <div class="bg-white rounded-xl p-4 card-shadow mb-8">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                    <span class="text-sm font-medium text-gray-700">Firebase Realtime Database</span>
                    <span class="text-xs text-gray-500" id="ultimaSync">Sincronizando...</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="mostrarDebugInfo()" 
                            class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded text-sm transition duration-200">
                        🔍 Debug
                    </button>
                    <button onclick="forcarSincronizacao()" id="btnSync"
                            class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-1 px-3 rounded text-sm transition duration-200">
                        🔥 Forçar Sync
                    </button>
                    <button onclick="mostrarUsuariosOnline()"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded text-sm transition duration-200">
                        👥 Usuários Online
                    </button>
                </div>
            </div>
        </div>

        <!-- Formulário -->
        <div class="bg-white rounded-xl p-8 card-shadow mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">Nova Receita</h2>
            <form id="receitaForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Paciente</label>
                    <input type="text" id="nomePaciente" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                           oninput="formatarNome(this)">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Data de Emissão</label>
                    <input type="date" id="dataReceita" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Validade</label>
                    <select id="validadeMeses" required 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="1">1 mês</option>
                        <option value="2">2 meses</option>
                        <option value="3">3 meses</option>
                        <option value="4">4 meses</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Seu Nome</label>
                    <input type="text" id="usuarioAtual" placeholder="Digite seu nome..." required
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                
                <div class="flex items-end">
                    <button type="submit" id="btnSalvar"
                            class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                        🔥 Salvar no Firebase
                    </button>
                </div>
            </form>
        </div>

        <!-- Lista de Receitas -->
        <div class="bg-white rounded-xl p-8 card-shadow">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">Receitas da Equipe (Tempo Real)</h2>
                <div class="flex gap-2">
                    <button onclick="imprimirRelatorio()" 
                            class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded text-sm transition duration-200">
                        📋 Relatório Geral
                    </button>
                    <button onclick="imprimirRelatorioVencidas()" 
                            class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded text-sm transition duration-200">
                        🚨 Relatório Vencidas
                    </button>
                </div>
            </div>
            
            <!-- Filtros -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Nome</label>
                    <input type="text" id="filtroNome" placeholder="Digite o nome do paciente..."
                           class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="filtroStatus"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="">Todos</option>
                        <option value="valida">Válidas</option>
                        <option value="vencendo">Vencendo</option>
                        <option value="vencida">Vencidas</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Adicionado por</label>
                    <select id="filtroUsuario"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button onclick="limparFiltros()" 
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded text-sm transition duration-200">
                        Limpar Filtros
                    </button>
                </div>
            </div>
            
            <!-- Tabela -->
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-3 text-left font-medium text-gray-700">Paciente</th>
                            <th class="px-4 py-3 text-left font-medium text-gray-700">Data Emissão</th>
                            <th class="px-4 py-3 text-left font-medium text-gray-700">Vencimento</th>
                            <th class="px-4 py-3 text-left font-medium text-gray-700">Status</th>
                            <th class="px-4 py-3 text-left font-medium text-gray-700">Adicionado por</th>
                            <th class="px-4 py-3 text-left font-medium text-gray-700">Renovado por</th>
                            <th class="px-4 py-3 text-left font-medium text-gray-700">Renovar</th>
                            <th class="px-4 py-3 text-center font-medium text-gray-700">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaReceitas">
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                <div class="flex items-center justify-center gap-2">
                                    <div class="w-4 h-4 border-2 border-orange-500 border-t-transparent rounded-full animate-spin"></div>
                                    Carregando dados do Firebase...
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Paginação -->
            <div class="flex justify-between items-center mt-6 pt-4 border-t">
                <div class="text-sm text-gray-600">
                    Mostrando <span id="infoInicio">0</span> a <span id="infoFim">0</span> de <span id="infoTotal">0</span> receitas
                </div>
                <div class="flex gap-2">
                    <button onclick="paginaAnterior()" id="btnAnterior"
                            class="px-3 py-2 bg-gray-200 text-gray-600 rounded-md text-sm hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        ← Anterior
                    </button>
                    <span id="infoPagina" class="px-3 py-2 text-sm text-gray-600"></span>
                    <button onclick="proximaPagina()" id="btnProximo"
                            class="px-3 py-2 bg-gray-200 text-gray-600 rounded-md text-sm hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed">
                        Próximo →
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCmhzh-YdqdFgMq4J1edxibvRIPAHLHViU",
            authDomain: "controle-de-receitas-14d86.firebaseapp.com",
            projectId: "controle-de-receitas-14d86",
            storageBucket: "controle-de-receitas-14d86.firebasestorage.app",
            messagingSenderId: "947606894722",
            appId: "1:947606894722:web:baacb0a212b2a239129c9b"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Global variables
        let receitas = [];
        let paginaAtual = 1;
        const itensPorPagina = 15;
        let usuarioAtual = '';
        let unsubscribe = null;

        // Update connection status
        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            const indicator = document.getElementById('firebaseStatus');
            
            if (connected) {
                status.textContent = 'Firebase Conectado - Tempo Real Ativo';
                indicator.className = 'w-3 h-3 bg-green-500 rounded-full firebase-connected';
                document.getElementById('ultimaSync').textContent = `Última sync: ${new Date().toLocaleTimeString('pt-BR')}`;
            } else {
                status.textContent = 'Reconectando ao Firebase...';
                indicator.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';
            }
        }

        // Set current date
        const hoje = new Date();
        const ano = hoje.getFullYear();
        const mes = String(hoje.getMonth() + 1).padStart(2, '0');
        const dia = String(hoje.getDate()).padStart(2, '0');
        document.getElementById('dataReceita').value = `${ano}-${mes}-${dia}`;

        // Format name function
        window.formatarNome = function(input) {
            let valor = input.value;
            let palavras = valor.split(' ');
            let palavrasFormatadas = palavras.map(palavra => {
                if (palavra.length > 0) {
                    return palavra.charAt(0).toUpperCase() + palavra.slice(1).toLowerCase();
                }
                return palavra;
            });
            input.value = palavrasFormatadas.join(' ');
        }

        // Calculate status function
        function calcularStatus(dataReceita, validadeMeses) {
            const hoje = new Date();
            const dataEmissao = new Date(dataReceita);
            const dataVencimento = new Date(dataEmissao);
            dataVencimento.setMonth(dataVencimento.getMonth() + parseInt(validadeMeses));
            
            const diasParaVencer = Math.ceil((dataVencimento - hoje) / (1000 * 60 * 60 * 24));
            
            if (diasParaVencer < 0) return 'vencida';
            if (diasParaVencer <= 7) return 'vencendo';
            return 'valida';
        }

        // Update dashboard
        function atualizarDashboard() {
            let vencendo = 0;
            let vencidas = 0;
            let total = receitas.length;
            
            receitas.forEach(receita => {
                const status = calcularStatus(receita.dataReceita, receita.validadeMeses);
                if (status === 'vencendo') vencendo++;
                if (status === 'vencida') vencidas++;
            });
            
            document.getElementById('vencendo').textContent = vencendo;
            document.getElementById('vencidas').textContent = vencidas;
            document.getElementById('totalReceitas').textContent = total;
        }

        // Get filtered recipes
        function obterReceitasFiltradas() {
            let receitasFiltradas = [...receitas];
            
            const filtroNome = document.getElementById('filtroNome').value.toLowerCase();
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroUsuario = document.getElementById('filtroUsuario').value;
            
            if (filtroNome) {
                receitasFiltradas = receitasFiltradas.filter(receita => 
                    receita.nomePaciente.toLowerCase().includes(filtroNome)
                );
            }
            
            if (filtroStatus) {
                receitasFiltradas = receitasFiltradas.filter(receita => {
                    const status = calcularStatus(receita.dataReceita, receita.validadeMeses);
                    return status === filtroStatus;
                });
            }
            
            if (filtroUsuario) {
                receitasFiltradas = receitasFiltradas.filter(receita => 
                    receita.adicionadoPor === filtroUsuario
                );
            }
            
            // Sort by expiration date
            receitasFiltradas.sort((a, b) => {
                const dataA = new Date(a.dataReceita);
                dataA.setMonth(dataA.getMonth() + parseInt(a.validadeMeses));
                const dataB = new Date(b.dataReceita);
                dataB.setMonth(dataB.getMonth() + parseInt(b.validadeMeses));
                return dataA - dataB;
            });
            
            return receitasFiltradas;
        }

        // Render recipes table
        function renderizarReceitas() {
            const tabela = document.getElementById('tabelaReceitas');
            
            if (receitas.length === 0) {
                tabela.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Nenhuma receita no Firebase ainda</td></tr>';
                atualizarInfoPaginacao(0, 0, 0);
                return;
            }
            
            const receitasFiltradas = obterReceitasFiltradas();
            
            if (receitasFiltradas.length === 0) {
                tabela.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Nenhuma receita encontrada com os filtros aplicados</td></tr>';
                atualizarInfoPaginacao(0, 0, 0);
                return;
            }
            
            // Calculate pagination
            const totalItens = receitasFiltradas.length;
            const totalPaginas = Math.ceil(totalItens / itensPorPagina);
            
            if (paginaAtual > totalPaginas) {
                paginaAtual = 1;
            }
            
            const inicio = (paginaAtual - 1) * itensPorPagina;
            const fim = Math.min(inicio + itensPorPagina, totalItens);
            const receitasPagina = receitasFiltradas.slice(inicio, fim);
            
            tabela.innerHTML = receitasPagina.map((receita) => {
                const status = calcularStatus(receita.dataReceita, receita.validadeMeses);
                const dataVencimento = new Date(receita.dataReceita);
                dataVencimento.setMonth(dataVencimento.getMonth() + parseInt(receita.validadeMeses));
                
                const statusText = status === 'vencida' ? 'Vencida' : 
                                 status === 'vencendo' ? 'Vencendo' : 'Válida';
                
                const statusColor = status === 'vencida' ? 'text-red-600 bg-red-100' : 
                                  status === 'vencendo' ? 'text-yellow-600 bg-yellow-100' : 'text-green-600 bg-green-100';
                
                const rowColor = status === 'vencida' ? 'bg-red-50' : 
                               status === 'vencendo' ? 'bg-yellow-50' : '';
                
                return `
                    <tr class="${rowColor} border-b hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-gray-900">${receita.nomePaciente}</td>
                        <td class="px-4 py-3 text-gray-600">${new Date(receita.dataReceita).toLocaleDateString('pt-BR')}</td>
                        <td class="px-4 py-3 text-gray-600">${dataVencimento.toLocaleDateString('pt-BR')}</td>
                        <td class="px-4 py-3">
                            <span class="text-xs font-medium px-2 py-1 rounded-full ${statusColor}">${statusText}</span>
                        </td>
                        <td class="px-4 py-3 text-gray-600 text-xs">${receita.adicionadoPor || 'Sistema'}</td>
                        <td class="px-4 py-3 text-gray-600 text-xs">${receita.renovadoPor || '-'}</td>
                        <td class="px-4 py-3">
                            <select class="px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-orange-500"
                                    onchange="renovarReceita('${receita.id}', this.value, this)"
                                    id="select-${receita.id}"
                                    title="Selecione a nova validade">
                                <option value="">Renovar...</option>
                                <option value="1">1 mês</option>
                                <option value="2">2 meses</option>
                                <option value="3">3 meses</option>
                                <option value="4">4 meses</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <button onclick="removerReceita('${receita.id}')" 
                                    class="text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 rounded hover:bg-red-100"
                                    title="Excluir receita">
                                Excluir
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            atualizarInfoPaginacao(inicio + 1, fim, totalItens);
            atualizarBotoesPaginacao(totalPaginas);
        }

        // Update user filter
        function atualizarFiltroUsuarios() {
            const filtroUsuario = document.getElementById('filtroUsuario');
            const usuarios = [...new Set(receitas.map(r => r.adicionadoPor).filter(u => u))];
            
            filtroUsuario.innerHTML = '<option value="">Todos</option>';
            usuarios.forEach(usuario => {
                filtroUsuario.innerHTML += `<option value="${usuario}">${usuario}</option>`;
            });
        }

        // Listen to Firebase changes
        function iniciarListenerFirebase() {
            console.log('🔥 Conectando ao Firebase...');
            
            // First try to get data without ordering to test connection
            const receitasRef = collection(db, 'receitas');
            
            unsubscribe = onSnapshot(receitasRef, (snapshot) => {
                console.log('📡 Firebase conectado! Documentos:', snapshot.size);
                receitas = [];
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('📄 Documento:', doc.id, data);
                    receitas.push({
                        id: doc.id,
                        ...data,
                        dataAdicao: data.dataAdicao?.toDate?.() || new Date()
                    });
                });
                
                // Sort manually since orderBy might cause issues
                receitas.sort((a, b) => {
                    const dateA = a.dataAdicao || new Date(0);
                    const dateB = b.dataAdicao || new Date(0);
                    return dateB - dateA;
                });
                
                updateConnectionStatus(true);
                atualizarDashboard();
                renderizarReceitas();
                atualizarFiltroUsuarios();
                
                // Update online users count
                const usuarios = [...new Set(receitas.map(r => r.adicionadoPor).filter(u => u))];
                document.getElementById('usuariosOnline').textContent = `${usuarios.length} usuários cadastraram receitas`;
                
                console.log('✅ Interface atualizada com', receitas.length, 'receitas');
            }, (error) => {
                console.error('❌ Erro Firebase:', error);
                updateConnectionStatus(false);
                
                // Show specific error to user
                if (error.code === 'permission-denied') {
                    document.getElementById('connectionStatus').textContent = 'Erro: Permissões do Firebase - Configure as regras';
                    document.getElementById('firebaseInstructions').style.display = 'block';
                    document.getElementById('tabelaReceitas').innerHTML = `
                        <tr><td colspan="8" class="px-4 py-8 text-center text-red-600">
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h3 class="font-bold mb-2">🚨 Erro de Permissão Firebase</h3>
                                <p class="mb-2">As regras do Firestore precisam ser configuradas.</p>
                                <p class="text-sm">Veja as instruções acima para configurar as permissões.</p>
                                <button onclick="window.open('https://console.firebase.google.com/project/controle-de-receitas-14d86/firestore/rules', '_blank')" 
                                        class="mt-3 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">
                                    🔧 Abrir Console Firebase
                                </button>
                            </div>
                        </td></tr>
                    `;
                } else {
                    document.getElementById('connectionStatus').textContent = `Erro Firebase: ${error.message}`;
                    document.getElementById('tabelaReceitas').innerHTML = `
                        <tr><td colspan="8" class="px-4 py-8 text-center text-red-600">
                            <div class="bg-red-50 p-4 rounded-lg">
                                <h3 class="font-bold mb-2">❌ Erro de Conexão Firebase</h3>
                                <p class="mb-2">Código: ${error.code}</p>
                                <p class="mb-2">Mensagem: ${error.message}</p>
                                <button onclick="location.reload()" 
                                        class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm">
                                    🔄 Tentar Novamente
                                </button>
                            </div>
                        </td></tr>
                    `;
                }
            });
        }

        // Add recipe form handler
        document.getElementById('receitaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const usuario = document.getElementById('usuarioAtual').value.trim();
            if (!usuario) {
                alert('Por favor, informe seu nome!');
                document.getElementById('usuarioAtual').focus();
                return;
            }
            
            const btnSalvar = document.getElementById('btnSalvar');
            const originalText = btnSalvar.innerHTML;
            btnSalvar.innerHTML = '🔄 Salvando...';
            btnSalvar.disabled = true;
            
            try {
                const novaReceita = {
                    nomePaciente: document.getElementById('nomePaciente').value,
                    dataReceita: document.getElementById('dataReceita').value,
                    validadeMeses: document.getElementById('validadeMeses').value,
                    adicionadoPor: usuario,
                    dataAdicao: serverTimestamp()
                };
                
                await addDoc(collection(db, 'receitas'), novaReceita);
                
                // Clear form (except user)
                document.getElementById('nomePaciente').value = '';
                document.getElementById('validadeMeses').selectedIndex = 0;
                
                // Keep current date
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                const dia = String(hoje.getDate()).padStart(2, '0');
                document.getElementById('dataReceita').value = `${ano}-${mes}-${dia}`;
                
                paginaAtual = 1;
                
                btnSalvar.innerHTML = '✅ Salvo no Firebase!';
                btnSalvar.className = 'w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2';
                
                setTimeout(() => {
                    btnSalvar.innerHTML = originalText;
                    btnSalvar.className = 'w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 flex items-center justify-center gap-2';
                    btnSalvar.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('Erro ao salvar no Firebase. Tente novamente.');
                btnSalvar.innerHTML = originalText;
                btnSalvar.disabled = false;
            }
        });

        // Renew recipe function
        window.renovarReceita = async function(receitaId, novaValidadeMeses, selectElement) {
            if (!novaValidadeMeses) return;
            
            const usuario = document.getElementById('usuarioAtual').value.trim();
            if (!usuario) {
                alert('Por favor, informe seu nome antes de renovar!');
                document.getElementById('usuarioAtual').focus();
                // Reset only this specific select
                if (selectElement) {
                    selectElement.selectedIndex = 0;
                }
                return;
            }
            
            // Disable this specific select during processing
            if (selectElement) {
                selectElement.disabled = true;
                selectElement.className = selectElement.className.replace('border-gray-300', 'border-orange-500');
            }
            
            try {
                const hoje = new Date();
                const ano = hoje.getFullYear();
                const mes = String(hoje.getMonth() + 1).padStart(2, '0');
                const dia = String(hoje.getDate()).padStart(2, '0');
                const dataHoje = `${ano}-${mes}-${dia}`;
                
                await updateDoc(doc(db, 'receitas', receitaId), {
                    dataReceita: dataHoje,
                    validadeMeses: novaValidadeMeses,
                    renovadoPor: usuario,
                    dataRenovacao: serverTimestamp()
                });
                
                // Success feedback for this specific select
                if (selectElement) {
                    selectElement.className = selectElement.className.replace('border-orange-500', 'border-green-500');
                    setTimeout(() => {
                        selectElement.className = 'px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-orange-500';
                        selectElement.selectedIndex = 0;
                        selectElement.disabled = false;
                    }, 2000);
                }
                
                alert(`✅ Receita renovada no Firebase!\nRenovada por: ${usuario}\nNova data: ${hoje.toLocaleDateString('pt-BR')}\nNova validade: ${novaValidadeMeses} mês(es)`);
                
            } catch (error) {
                console.error('Erro ao renovar:', error);
                alert('Erro ao renovar no Firebase. Tente novamente.');
                
                // Reset this specific select on error
                if (selectElement) {
                    selectElement.className = 'px-2 py-1 border border-gray-300 rounded text-xs focus:ring-1 focus:ring-orange-500';
                    selectElement.selectedIndex = 0;
                    selectElement.disabled = false;
                }
            }
        }

        // Remove recipe function
        window.removerReceita = async function(receitaId) {
            if (confirm('⚠️ Tem certeza que deseja remover esta receita?\nEsta ação será sincronizada com toda a equipe!')) {
                try {
                    await deleteDoc(doc(db, 'receitas', receitaId));
                } catch (error) {
                    console.error('Erro ao remover:', error);
                    alert('Erro ao remover do Firebase. Tente novamente.');
                }
            }
        }

        // Force sync function
        window.forcarSincronizacao = function() {
            const btn = document.getElementById('btnSync');
            const originalText = btn.textContent;
            
            btn.textContent = 'Sincronizando...';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.textContent = '✅ Sincronizado!';
                btn.className = 'bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded text-sm transition duration-200';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.className = 'bg-orange-600 hover:bg-orange-700 text-white font-semibold py-1 px-3 rounded text-sm transition duration-200';
                    btn.disabled = false;
                }, 2000);
            }, 1000);
        }

        // Show online users function
        window.mostrarUsuariosOnline = function() {
            const usuarios = [...new Set(receitas.map(r => r.adicionadoPor).filter(u => u))];
            const usuariosText = usuarios.length > 0 ? usuarios.join(', ') : 'Nenhum usuário identificado';
            alert(`👥 Usuários da Equipe:\n\n${usuariosText}\n\n🔥 Dados sincronizados pelo Firebase em tempo real!`);
        }

        // Debug function
        window.mostrarDebugInfo = function() {
            const debugInfo = `
🔍 DEBUG FIREBASE:

📡 Status Conexão: ${document.getElementById('connectionStatus').textContent}
📊 Total Receitas: ${receitas.length}
🔥 Firebase Config: ${firebaseConfig.projectId}
📱 URL Atual: ${window.location.href}
🌐 Navegador: ${navigator.userAgent.split(' ').pop()}

📄 Console Logs:
- Abra F12 → Console para ver logs detalhados
- Procure por mensagens com 🔥 📡 ✅ ❌

🔧 Próximos Passos:
1. Verifique o Console (F12)
2. Teste adicionar uma receita
3. Verifique as regras do Firestore
            `;
            
            alert(debugInfo);
            console.log('🔍 DEBUG INFO:', {
                receitas: receitas,
                config: firebaseConfig,
                connectionStatus: document.getElementById('connectionStatus').textContent,
                url: window.location.href
            });
        }



        // Print general report function
        window.imprimirRelatorio = function() {
            const receitasFiltradas = obterReceitasFiltradas();
            
            if (receitasFiltradas.length === 0) {
                alert('Nenhuma receita para imprimir!');
                return;
            }
            
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const horaAtual = new Date().toLocaleTimeString('pt-BR');
            
            let html = `
                <html>
                <head>
                    <title>Relatório Firebase - Receitas da Equipe</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 15px; font-size: 12px; }
                        .header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid #ff6b35; padding-bottom: 10px; }
                        .header h1 { font-size: 18px; margin: 5px 0; color: #ff6b35; }
                        .header p { font-size: 11px; margin: 3px 0; }
                        .info { margin-bottom: 15px; font-size: 11px; background: #fff7ed; padding: 10px; border-radius: 5px; border: 1px solid #ff6b35; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10px; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                        th { background-color: #ff6b35; color: white; font-weight: bold; font-size: 10px; }
                        .status-vencida { background-color: #fee2e2; }
                        .status-vencendo { background-color: #fef3c7; }
                        .status-valida { background-color: #d1fae5; }
                        .footer { margin-top: 20px; text-align: center; font-size: 9px; color: #666; border-top: 1px solid #ff6b35; padding-top: 10px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>🔥 Controle de Receitas TricoMaster - Firebase</h1>
                        <p>Relatório da Equipe - Dados Sincronizados em Tempo Real</p>
                        <p>Gerado em: ${dataAtual} às ${horaAtual}</p>
                    </div>
                    
                    <div class="info">
                        <p><strong>📊 Resumo Firebase:</strong></p>
                        <p>• Total de receitas: ${receitasFiltradas.length}</p>
                        <p>• Receitas vencidas: ${receitasFiltradas.filter(r => calcularStatus(r.dataReceita, r.validadeMeses) === 'vencida').length}</p>
                        <p>• Receitas vencendo: ${receitasFiltradas.filter(r => calcularStatus(r.dataReceita, r.validadeMeses) === 'vencendo').length}</p>
                        <p>• Receitas válidas: ${receitasFiltradas.filter(r => calcularStatus(r.dataReceita, r.validadeMeses) === 'valida').length}</p>
                        <p>• 🔥 Dados sincronizados automaticamente entre toda a equipe</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Paciente</th>
                                <th>Data Emissão</th>
                                <th>Data Vencimento</th>
                                <th>Validade</th>
                                <th>Status</th>
                                <th>Adicionado por</th>
                                <th>Renovado por</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            receitasFiltradas.forEach(receita => {
                const status = calcularStatus(receita.dataReceita, receita.validadeMeses);
                const dataVencimento = new Date(receita.dataReceita);
                dataVencimento.setMonth(dataVencimento.getMonth() + parseInt(receita.validadeMeses));
                
                const statusText = status === 'vencida' ? 'Vencida' : 
                                 status === 'vencendo' ? 'Vencendo' : 'Válida';
                
                const statusClass = status === 'vencida' ? 'status-vencida' : 
                                  status === 'vencendo' ? 'status-vencendo' : 'status-valida';
                
                html += `
                    <tr class="${statusClass}">
                        <td><strong>${receita.nomePaciente}</strong></td>
                        <td>${new Date(receita.dataReceita).toLocaleDateString('pt-BR')}</td>
                        <td>${dataVencimento.toLocaleDateString('pt-BR')}</td>
                        <td>${receita.validadeMeses} mês(es)</td>
                        <td><strong>${statusText}</strong></td>
                        <td>${receita.adicionadoPor || 'Sistema'}</td>
                        <td>${receita.renovadoPor || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong>🔥 Controle de Receitas TricoMaster - Firebase Realtime</strong></p>
                        <p>Sistema com sincronização automática em tempo real para toda a equipe</p>
                    </div>
                </body>
                </html>
            `;
            
            const novaJanela = window.open('', '_blank');
            novaJanela.document.write(html);
            novaJanela.document.close();
            novaJanela.print();
        }

        // Print expired report function
        window.imprimirRelatorioVencidas = function() {
            const receitasFiltradas = obterReceitasFiltradas();
            const receitasVencidas = receitasFiltradas.filter(receita => {
                const status = calcularStatus(receita.dataReceita, receita.validadeMeses);
                return status === 'vencida';
            });
            
            if (receitasVencidas.length === 0) {
                alert('🎉 Nenhuma receita vencida encontrada!\nTodas as receitas estão em dia no Firebase!');
                return;
            }
            
            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const horaAtual = new Date().toLocaleTimeString('pt-BR');
            
            let html = `
                <html>
                <head>
                    <title>Relatório URGENTE Firebase - Receitas Vencidas</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 15px; font-size: 12px; }
                        .header { text-align: center; margin-bottom: 20px; border: 3px solid #dc2626; padding: 15px; background: #fee2e2; }
                        .header h1 { font-size: 18px; margin: 5px 0; color: #dc2626; }
                        .header p { font-size: 11px; margin: 3px 0; }
                        .alert { background-color: #fee2e2; border: 2px solid #fecaca; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
                        .alert h3 { color: #dc2626; margin: 0 0 10px 0; font-size: 14px; }
                        .info { margin-bottom: 15px; font-size: 11px; background: #fff7ed; padding: 10px; border-radius: 5px; border: 1px solid #ff6b35; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10px; }
                        th, td { border: 1px solid #ddd; padding: 6px; text-align: left; }
                        th { background-color: #dc2626; color: white; font-weight: bold; font-size: 10px; }
                        .status-vencida { background-color: #fee2e2; }
                        .footer { margin-top: 20px; text-align: center; font-size: 9px; color: #666; border-top: 2px solid #dc2626; padding-top: 10px; }
                        .urgente { color: #dc2626; font-weight: bold; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>🚨 RELATÓRIO URGENTE FIREBASE - RECEITAS VENCIDAS</h1>
                        <p>Controle de Receitas TricoMaster - Sistema Firebase</p>
                        <p>Gerado em: ${dataAtual} às ${horaAtual}</p>
                    </div>
                    
                    <div class="alert">
                        <h3>⚠️ ATENÇÃO URGENTE!</h3>
                        <p>Este relatório contém <strong>${receitasVencidas.length} receitas que já venceram</strong> no sistema Firebase.</p>
                        <p>Todas as receitas listadas abaixo estão <strong>FORA DA VALIDADE</strong> e precisam de renovação imediata.</p>
                        <p>🔥 <strong>Dados sincronizados em tempo real</strong> - Toda a equipe vê as mesmas informações.</p>
                    </div>
                    
                    <div class="info">
                        <p><strong>📊 Resumo Crítico Firebase:</strong></p>
                        <p>• <span class="urgente">Total de receitas vencidas: ${receitasVencidas.length}</span></p>
                        <p>• Equipe responsável: ${[...new Set(receitasVencidas.map(r => r.adicionadoPor).filter(u => u))].join(', ')}</p>
                        <p>• Ação necessária: <strong>RENOVAÇÃO IMEDIATA NO SISTEMA</strong></p>
                        <p>• 🔥 Sistema Firebase garante que todos vejam as atualizações instantaneamente</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Paciente</th>
                                <th>Data Emissão</th>
                                <th>Data Vencimento</th>
                                <th>Dias Vencida</th>
                                <th>Responsável</th>
                                <th>Prioridade</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            receitasVencidas.forEach(receita => {
                const dataVencimento = new Date(receita.dataReceita);
                dataVencimento.setMonth(dataVencimento.getMonth() + parseInt(receita.validadeMeses));
                
                const hoje = new Date();
                const diasVencida = Math.abs(Math.ceil((dataVencimento - hoje) / (1000 * 60 * 60 * 24)));
                
                const prioridade = diasVencida > 30 ? 'CRÍTICA' : diasVencida > 15 ? 'ALTA' : 'URGENTE';
                
                html += `
                    <tr class="status-vencida">
                        <td><strong>${receita.nomePaciente}</strong></td>
                        <td>${new Date(receita.dataReceita).toLocaleDateString('pt-BR')}</td>
                        <td>${dataVencimento.toLocaleDateString('pt-BR')}</td>
                        <td><strong class="urgente">${diasVencida} dias</strong></td>
                        <td>${receita.adicionadoPor || 'Sistema'}</td>
                        <td><strong class="urgente">${prioridade}</strong></td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p><strong class="urgente">🚨 AÇÃO IMEDIATA NECESSÁRIA 🚨</strong></p>
                        <p>Todas as receitas listadas precisam ser renovadas HOJE no sistema Firebase!</p>
                        <p>🔥 Controle de Receitas TricoMaster - Firebase Realtime Database</p>
                        <p>Sistema com sincronização automática em tempo real para toda a equipe</p>
                    </div>
                </body>
                </html>
            `;
            
            const novaJanela = window.open('', '_blank');
            novaJanela.document.write(html);
            novaJanela.document.close();
            novaJanela.print();
        }

        // Clear filters function
        window.limparFiltros = function() {
            document.getElementById('filtroNome').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroUsuario').value = '';
            paginaAtual = 1;
            renderizarReceitas();
        }

        // Pagination functions
        function atualizarInfoPaginacao(inicio, fim, total) {
            document.getElementById('infoInicio').textContent = inicio;
            document.getElementById('infoFim').textContent = fim;
            document.getElementById('infoTotal').textContent = total;
            
            const totalPaginas = Math.ceil(total / itensPorPagina);
            document.getElementById('infoPagina').textContent = total > 0 ? `Página ${paginaAtual} de ${totalPaginas}` : '';
        }

        function atualizarBotoesPaginacao(totalPaginas) {
            const btnAnterior = document.getElementById('btnAnterior');
            const btnProximo = document.getElementById('btnProximo');
            
            btnAnterior.disabled = paginaAtual <= 1;
            btnProximo.disabled = paginaAtual >= totalPaginas;
            
            if (btnAnterior.disabled) {
                btnAnterior.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btnAnterior.classList.remove('opacity-50', 'cursor-not-allowed');
            }
            
            if (btnProximo.disabled) {
                btnProximo.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                btnProximo.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        window.paginaAnterior = function() {
            if (paginaAtual > 1) {
                paginaAtual--;
                renderizarReceitas();
            }
        }

        window.proximaPagina = function() {
            const receitasFiltradas = obterReceitasFiltradas();
            const totalPaginas = Math.ceil(receitasFiltradas.length / itensPorPagina);
            if (paginaAtual < totalPaginas) {
                paginaAtual++;
                renderizarReceitas();
            }
        }

        // Filter event listeners
        document.getElementById('filtroNome').addEventListener('input', function() {
            paginaAtual = 1;
            renderizarReceitas();
        });
        document.getElementById('filtroStatus').addEventListener('change', function() {
            paginaAtual = 1;
            renderizarReceitas();
        });
        document.getElementById('filtroUsuario').addEventListener('change', function() {
            paginaAtual = 1;
            renderizarReceitas();
        });

        // Initialize app
        function inicializarApp() {
            console.log('🔥 Iniciando Firebase...');
            iniciarListenerFirebase();
        }

        // Initialize when page loads
        window.addEventListener('load', inicializarApp);
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (unsubscribe) unsubscribe();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9602396397e19d59',t:'MTc1MjY3NjUwNi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
